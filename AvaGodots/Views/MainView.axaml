<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:AvaGodots.ViewModels"
             xmlns:local="using:AvaGodots"
             mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="600"
             x:Class="AvaGodots.Views.MainView"
             x:DataType="vm:MainViewModel"
             Background="#252B35">

  <Design.DataContext>
    <vm:MainViewModel/>
  </Design.DataContext>

  <Grid RowDefinitions="Auto,*,Auto">

    <!-- ========== 标题栏 ========== -->
    <Border Grid.Row="0" Background="#1C2129" IsHitTestVisible="True">
      <Grid ColumnDefinitions="Auto,*,Auto" Height="40">

        <Panel Grid.Column="0" Width="80" IsHitTestVisible="False"/>

        <!-- 标签页切换 -->
        <StackPanel Grid.Column="1" Orientation="Horizontal"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    Spacing="4">

          <ToggleButton Classes="titleTab"
                        IsChecked="{Binding IsProjectsTabSelected, Mode=OneWay}"
                        Command="{Binding NavigateToProjectsCommand}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <PathIcon Data="{StaticResource document_edit_regular}" FontSize="16"/>
              <TextBlock Text="{DynamicResource Tab.Projects}" VerticalAlignment="Center"/>
            </StackPanel>
          </ToggleButton>

          <ToggleButton Classes="titleTab"
                        IsChecked="{Binding IsAssetLibTabSelected, Mode=OneWay}"
                        Command="{Binding NavigateToAssetLibCommand}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <PathIcon Data="{StaticResource arrow_download_regular}" FontSize="16"/>
              <TextBlock Text="{DynamicResource Tab.AssetLib}" VerticalAlignment="Center"/>
            </StackPanel>
          </ToggleButton>

          <ToggleButton Classes="titleTab"
                        IsChecked="{Binding IsEditorsTabSelected, Mode=OneWay}"
                        Command="{Binding NavigateToEditorsCommand}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <PathIcon Data="{StaticResource app_generic_regular}" FontSize="16"/>
              <TextBlock Text="{DynamicResource Tab.Editors}" VerticalAlignment="Center"/>
            </StackPanel>
          </ToggleButton>

        </StackPanel>

        <!-- 右侧：版本号 + 设置 -->
        <StackPanel Grid.Column="2" Orientation="Horizontal"
                    HorizontalAlignment="Right" VerticalAlignment="Center"
                    Spacing="4" Margin="0,0,8,0">
          <Button Classes="iconAction"
                  Command="{Binding NavigateToSettingsCommand}"
                  ToolTip.Tip="{DynamicResource Main.Tooltip.Settings}">
            <PathIcon Data="{StaticResource settings_regular}" FontSize="18"/>
          </Button>
        </StackPanel>

      </Grid>
    </Border>

    <!-- ========== 内容区域 ========== -->
    <Panel Grid.Row="1">
      <TransitioningContentControl Content="{Binding CurrentPage}">
        <TransitioningContentControl.PageTransition>
          <CrossFade Duration="0:0:0.2"/>
        </TransitioningContentControl.PageTransition>
      </TransitioningContentControl>
    </Panel>

    <!-- ========== 底部状态栏 + 下载进度 ========== -->
    <Border Grid.Row="2" Background="#1C2129" Padding="0" MinHeight="28">
      <DockPanel>

        <!-- 下载进度条（底部居中水平滚动区域） -->
        <ScrollViewer DockPanel.Dock="Top"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Disabled"
                      IsVisible="{Binding HasActiveDownloads}">
          <ItemsControl ItemsSource="{Binding Downloads}" Margin="8,4">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate><StackPanel Orientation="Horizontal" Spacing="8"/></ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Background="{DynamicResource DarkColor2}" CornerRadius="4"
                        Padding="8,6" MinWidth="240" MaxWidth="300">
                  <Grid RowDefinitions="Auto,Auto,Auto">
                    <DockPanel Grid.Row="0">
                      <Button DockPanel.Dock="Right" Classes="iconAction" Padding="2"
                              Command="{Binding $parent[ItemsControl].((vm:MainViewModel)DataContext).DismissDownloadCommand}"
                              CommandParameter="{Binding}"
                              ToolTip.Tip="{DynamicResource Common.Dismiss}">
                        <PathIcon Data="{StaticResource dismiss_regular}" FontSize="12"/>
                      </Button>
                      <TextBlock Text="{Binding Title}" FontSize="12" FontWeight="SemiBold"
                                 TextTrimming="CharacterEllipsis"/>
                    </DockPanel>
                    <ProgressBar Grid.Row="1" Value="{Binding Progress}" Maximum="{Binding MaxProgress}"
                                 Height="4" Margin="0,4,0,2"/>
                    <TextBlock Grid.Row="2" Text="{Binding StatusText}" FontSize="10"
                               Foreground="{DynamicResource FontDimBrush}"/>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>

        <!-- 状态文本 -->
        <Grid Margin="12,4" ColumnDefinitions="*,Auto">
          <TextBlock Grid.Column="0" Text="{Binding StatusText}" FontSize="11"
                     Foreground="{DynamicResource FontDimBrush}" VerticalAlignment="Center"/>
          <Button Grid.Column="1" Classes="hyperlink" Command="{Binding OpenRepositoryCommand}"
                  Content="{Binding VersionText}" FontSize="11" Padding="0" Margin="0"
                  Foreground="{DynamicResource FontDimBrush}" VerticalAlignment="Center"
                  ToolTip.Tip="{DynamicResource Main.Tooltip.OpenRepository}"/>
        </Grid>
      </DockPanel>
    </Border>

    <!-- ========== 加载叠加层 ========== -->
    <Border Grid.Row="0" Grid.RowSpan="3"
            Background="#80000000"
            IsVisible="{Binding IsLoading}"
            IsHitTestVisible="{Binding IsLoading}">
      <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="12">
        <ProgressBar IsIndeterminate="True" Width="200"/>
        <TextBlock Text="{Binding StatusText}"
                   Foreground="{DynamicResource FontBrush}"
                   HorizontalAlignment="Center"/>
      </StackPanel>
    </Border>
  </Grid>
</UserControl>
