<!--
编辑器管理页面 — 对应 godots LocalEditorsControl
功能：编辑器列表、导入/扫描、本地/远程切换、重命名、额外参数、标签管理、
引用查看、删除确认(可选删除文件)、右键菜单、hover操作、双击运行、空状态
-->
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:AvaGodots.ViewModels.Pages"
             xmlns:conv="using:AvaGodots.Converters"
             xmlns:models="using:AvaGodots.Models"
             xmlns:ic="using:FluentIcons.Avalonia"
             mc:Ignorable="d"
             x:Class="AvaGodots.Views.Pages.EditorsPage"
             x:DataType="vm:EditorsPageViewModel">

  <Grid ColumnDefinitions="*,Auto">

    <!-- ========== 左侧主内容区 ========== -->
    <DockPanel Grid.Column="0" Margin="8">

      <!-- 顶部操作栏 -->
      <Border DockPanel.Dock="Top" Margin="0,0,0,8">
        <Grid RowDefinitions="Auto,Auto">

          <!-- 第一行：操作按钮 + Local/Remote 切换 -->
          <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,6">
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="4">
              <Button Classes="action" Command="{Binding ShowImportDialogCommand}">
                <StackPanel Orientation="Horizontal" Spacing="4">
                  <ic:SymbolIcon Symbol="FolderOpen" IconVariant="Regular" FontSize="14"/>
                  <TextBlock Text="Import" VerticalAlignment="Center" FontSize="13"/>
                </StackPanel>
              </Button>
              <Button Classes="action" Command="{Binding ScanDirectoryCommand}">
                <StackPanel Orientation="Horizontal" Spacing="4">
                  <ic:SymbolIcon Symbol="Search" IconVariant="Regular" FontSize="14"/>
                  <TextBlock Text="Scan" VerticalAlignment="Center" FontSize="13"/>
                </StackPanel>
              </Button>
              <Button Classes="action" Command="{Binding RemoveMissingEditorsCommand}">
                <StackPanel Orientation="Horizontal" Spacing="4">
                  <ic:SymbolIcon Symbol="Delete" IconVariant="Regular" FontSize="14"/>
                  <TextBlock Text="Remove Missing" VerticalAlignment="Center" FontSize="13"/>
                </StackPanel>
              </Button>
              <Button Classes="iconAction" Command="{Binding RefreshCommand}" ToolTip.Tip="Refresh">
                <ic:SymbolIcon Symbol="ArrowSync" IconVariant="Regular" FontSize="14"/>
              </Button>
            </StackPanel>

            <!-- Local/Remote 切换 -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="2">
              <ToggleButton Classes="titleTab" IsChecked="{Binding IsLocalView}"
                            Command="{Binding SwitchViewCommand}" CommandParameter="{x:True}">
                <TextBlock Text="Local" FontSize="12"/>
              </ToggleButton>
              <ToggleButton Classes="titleTab" IsChecked="{Binding !IsLocalView}"
                            Command="{Binding SwitchViewCommand}" CommandParameter="{x:False}">
                <TextBlock Text="Remote" FontSize="12"/>
              </ToggleButton>
            </StackPanel>
          </Grid>

          <!-- 第二行: 搜索框 + 排序 -->
          <Grid Grid.Row="1" ColumnDefinitions="*,Auto">
            <TextBox Grid.Column="0" Classes="searchBox"
                     Watermark="Filter Editors (tag:xxx)"
                     Text="{Binding SearchText, Mode=TwoWay}"/>
            <ComboBox Grid.Column="1" Classes="sortCombo"
                      SelectedIndex="{Binding SortIndex}"
                      MinWidth="100" Margin="8,0,0,0">
              <ComboBoxItem Content="Name"/>
              <ComboBoxItem Content="Path"/>
              <ComboBoxItem Content="Tags"/>
            </ComboBox>
          </Grid>
        </Grid>
      </Border>

      <!-- ========== LOCAL 视图：空状态提示 ========== -->
      <StackPanel DockPanel.Dock="Top"
                  IsVisible="{Binding IsEmpty}"
                  HorizontalAlignment="Center" VerticalAlignment="Center"
                  Spacing="8" Margin="0,60">
        <StackPanel.Styles>
          <Style Selector="StackPanel">
            <Setter Property="IsVisible" Value="{Binding IsLocalView}"/>
          </Style>
        </StackPanel.Styles>
        <ic:SymbolIcon Symbol="AppGeneric" IconVariant="Regular" FontSize="48"
                       Foreground="{DynamicResource FontDimBrush}" HorizontalAlignment="Center"/>
        <TextBlock Text="No editors yet" FontSize="16" Foreground="{DynamicResource FontDimBrush}"
                   HorizontalAlignment="Center"/>
        <TextBlock Text="Click 'Import' to add a local Godot editor, or 'Scan' to find editors in a directory."
                   FontSize="12" Foreground="{DynamicResource FontDimBrush}"
                   TextWrapping="Wrap" MaxWidth="400" HorizontalAlignment="Center"
                   TextAlignment="Center"/>
      </StackPanel>

      <!-- ========== REMOTE 视图：版本树 + 筛选 ========== -->
      <DockPanel DockPanel.Dock="Top" IsVisible="{Binding !IsLocalView}">

        <!-- 底部筛选复选框 -->
        <WrapPanel DockPanel.Dock="Bottom" Margin="0,8,0,0"
                   HorizontalAlignment="Center">
          <CheckBox Content="mono" IsChecked="{Binding FilterMono}"
                    Margin="4,0" FontSize="12" Foreground="{DynamicResource FontBrush}"/>
          <CheckBox Content="unstable" IsChecked="{Binding FilterUnstable}"
                    Margin="4,0" FontSize="12" Foreground="{DynamicResource FontBrush}"/>
          <CheckBox Content="any platform" IsChecked="{Binding FilterAnyPlatform}"
                    Margin="4,0" FontSize="12" Foreground="{DynamicResource FontBrush}"/>
          <CheckBox Content="64-bit" IsChecked="{Binding Filter64Bit}"
                    Margin="4,0" FontSize="12" Foreground="{DynamicResource FontBrush}"/>
          <CheckBox Content="4.x" IsChecked="{Binding Filter4X}"
                    Margin="4,0" FontSize="12" Foreground="{DynamicResource FontBrush}"/>
          <CheckBox Content="3.x" IsChecked="{Binding Filter3X}"
                    Margin="4,0" FontSize="12" Foreground="{DynamicResource FontBrush}"/>
          <CheckBox Content="x.x" IsChecked="{Binding FilterOtherVersions}"
                    Margin="4,0" FontSize="12" Foreground="{DynamicResource FontBrush}"/>
        </WrapPanel>

        <!-- 顶部操作栏 -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="4" Margin="0,0,0,8">
          <Button Classes="action">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <ic:SymbolIcon Symbol="ArrowDownload" IconVariant="Regular" FontSize="14"/>
              <TextBlock Text="Downloads" FontSize="12"/>
            </StackPanel>
          </Button>
          <Button Classes="action">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <ic:SymbolIcon Symbol="Link" IconVariant="Regular" FontSize="14"/>
              <TextBlock Text="Direct Link" FontSize="12"/>
            </StackPanel>
          </Button>
          <Panel HorizontalAlignment="Right"/>
          <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Right">
            <ComboBox Classes="sortCombo" MinWidth="100" SelectedIndex="0">
              <ComboBoxItem Content="GitHub"/>
            </ComboBox>
            <Button Classes="iconAction" Command="{Binding LoadRemoteVersionsCommand}" ToolTip.Tip="Refresh">
              <ic:SymbolIcon Symbol="ArrowSync" IconVariant="Regular" FontSize="14"/>
            </Button>
          </StackPanel>
        </StackPanel>

        <!-- 远程加载中 -->
        <Panel IsVisible="{Binding IsRemoteLoading}">
          <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8" Margin="0,40">
            <ic:SymbolIcon Symbol="ArrowSync" IconVariant="Regular" FontSize="32"
                           Foreground="{DynamicResource FontDimBrush}"/>
            <TextBlock Text="Loading versions..." Classes="emptyHint"/>
          </StackPanel>
        </Panel>

        <!-- 版本树 -->
        <TreeView ItemsSource="{Binding RemoteVersions}"
                  IsVisible="{Binding !IsRemoteLoading}">
          <TreeView.Styles>
            <Style Selector="TreeViewItem" x:DataType="models:RemoteVersionNode">
              <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
              <Setter Property="Foreground" Value="{DynamicResource FontBrush}"/>
              <Setter Property="FontSize" Value="13"/>
            </Style>
          </TreeView.Styles>
          <TreeView.ItemTemplate>
            <TreeDataTemplate ItemsSource="{Binding Children}">
              <Grid ColumnDefinitions="Auto,*,Auto" Margin="2">
                <ic:SymbolIcon Grid.Column="0"
                               Symbol="Folder"
                               FontSize="14" Margin="0,0,6,0"
                               Foreground="{DynamicResource FontDimBrush}"
                               IsVisible="{Binding IsFolder}"/>
                <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center"/>
                <Button Grid.Column="2" Classes="iconAction"
                        Command="{Binding $parent[TreeView].((vm:EditorsPageViewModel)DataContext).DownloadRemoteEditorCommand}"
                        CommandParameter="{Binding}"
                        IsVisible="{Binding !IsFolder}"
                        ToolTip.Tip="Download">
                  <ic:SymbolIcon Symbol="ArrowDownload" IconVariant="Regular" FontSize="14"/>
                </Button>
              </Grid>
            </TreeDataTemplate>
          </TreeView.ItemTemplate>
        </TreeView>
      </DockPanel>

      <!-- ========== LOCAL 视图：编辑器列表 ========== -->
      <ScrollViewer DockPanel.Dock="Bottom"
                    IsVisible="{Binding IsLocalView}"
                    VerticalScrollBarVisibility="Auto"
                    HorizontalScrollBarVisibility="Disabled">
        <ItemsControl ItemsSource="{Binding FilteredEditors}" Margin="0,0,4,0">
          <ItemsControl.ItemTemplate>
            <DataTemplate DataType="models:GodotEditor">
              <Border Padding="8,6" CornerRadius="4" Margin="0,1"
                      Name="editorItemBorder" Background="Transparent">
                <Border.Styles>
                  <Style Selector="Border#editorItemBorder:pointerover">
                    <Setter Property="Background" Value="{DynamicResource HoverBrush}"/>
                  </Style>
                  <Style Selector="Border#editorItemBorder StackPanel.hoverActions">
                    <Setter Property="IsVisible" Value="False"/>
                    <Setter Property="Opacity" Value="0"/>
                  </Style>
                  <Style Selector="Border#editorItemBorder:pointerover StackPanel.hoverActions">
                    <Setter Property="IsVisible" Value="True"/>
                    <Setter Property="Opacity" Value="1"/>
                  </Style>
                </Border.Styles>

                <!-- 右键上下文菜单 -->
                <Border.ContextMenu>
                  <ContextMenu>
                    <MenuItem Header="Run"
                              Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).RunEditorCommand}"
                              CommandParameter="{Binding}">
                      <MenuItem.Icon><ic:SymbolIcon Symbol="Play" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="Rename..."
                              Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ShowRenameDialogCommand}"
                              CommandParameter="{Binding}">
                      <MenuItem.Icon><ic:SymbolIcon Symbol="Rename" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="Manage Tags..."
                              Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ShowTagDialogCommand}"
                              CommandParameter="{Binding}">
                      <MenuItem.Icon><ic:SymbolIcon Symbol="Tag" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="Extra Arguments..."
                              Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ShowExtraArgsDialogCommand}"
                              CommandParameter="{Binding}">
                      <MenuItem.Icon><ic:SymbolIcon Symbol="Options" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="View References..."
                              Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ShowReferencesCommand}"
                              CommandParameter="{Binding}">
                      <MenuItem.Icon><ic:SymbolIcon Symbol="Link" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="Show in File Manager"
                              Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ShowInFileManagerCommand}"
                              CommandParameter="{Binding}">
                      <MenuItem.Icon><ic:SymbolIcon Symbol="FolderOpen" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="Copy Path"
                              Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).CopyPathCommand}"
                              CommandParameter="{Binding}">
                      <MenuItem.Icon><ic:SymbolIcon Symbol="ClipboardPaste" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="Remove"
                              Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ShowDeleteConfirmCommand}"
                              CommandParameter="{Binding}">
                      <MenuItem.Icon><ic:SymbolIcon Symbol="Delete" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                  </ContextMenu>
                </Border.ContextMenu>

                <Grid ColumnDefinitions="Auto,Auto,*,Auto"
                      DoubleTapped="OnEditorDoubleTapped">

                  <!-- 收藏按钮 -->
                  <ToggleButton Grid.Column="0" Classes="favorite"
                                IsChecked="{Binding IsFavorite}"
                                VerticalAlignment="Center" Margin="0,0,6,0"
                                Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ToggleFavoriteCommand}"
                                CommandParameter="{Binding}">
                    <Panel>
                      <ic:SymbolIcon Symbol="Star" IconVariant="Regular" FontSize="16"
                                     IsVisible="{Binding !IsFavorite}"/>
                      <ic:SymbolIcon Symbol="Star" IconVariant="Filled" FontSize="16"
                                     IsVisible="{Binding IsFavorite}"
                                     Foreground="{DynamicResource WarningBrush}"/>
                    </Panel>
                  </ToggleButton>

                  <!-- 编辑器图标 -->
                  <Border Grid.Column="1" Width="40" Height="40"
                          Background="{DynamicResource DarkColor3}"
                          CornerRadius="4" Margin="0,0,10,0" VerticalAlignment="Center">
                    <ic:SymbolIcon Symbol="AppGeneric" IconVariant="Regular" FontSize="20"
                                   Foreground="{DynamicResource GodotBlueBrush}"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                  </Border>

                  <!-- 编辑器信息 -->
                  <StackPanel Grid.Column="2" VerticalAlignment="Center" Spacing="2">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                      <TextBlock Text="{Binding Name}" FontSize="14" FontWeight="SemiBold"
                                 TextTrimming="CharacterEllipsis"/>
                      <TextBlock Text="{Binding VersionHint}" FontSize="11"
                                 Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center"
                                 IsVisible="{Binding VersionHint, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                      <!-- Self-contained 标识 -->
                      <Border Background="#40556B" CornerRadius="3" Padding="4,1"
                              IsVisible="{Binding IsSelfContained}" VerticalAlignment="Center">
                        <TextBlock Text="Self-contained" FontSize="9"
                                   Foreground="{DynamicResource FontBrush}"/>
                      </Border>

                      <!-- Mono/C# 标识 -->
                      <Border Background="#556B40" CornerRadius="3" Padding="4,1"
                              IsVisible="{Binding IsMono}" VerticalAlignment="Center">
                        <TextBlock Text="C#" FontSize="9"
                                   Foreground="{DynamicResource FontBrush}"/>
                      </Border>
                    </StackPanel>

                    <!-- 路径 -->
                    <TextBlock Text="{Binding Path}" Classes="path" MaxWidth="600"/>

                    <!-- 标签（可点击搜索） -->
                    <ItemsControl ItemsSource="{Binding Tags}" IsVisible="{Binding Tags.Count}">
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate><WrapPanel Orientation="Horizontal"/></ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <Button Classes="tagButton" Margin="0,2,4,0" Padding="6,2"
                                  Background="{DynamicResource TagBrush}" CornerRadius="3"
                                  BorderThickness="0" Cursor="Hand"
                                  Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).FilterByTagCommand}"
                                  CommandParameter="{Binding}">
                            <TextBlock Text="{Binding}" FontSize="11"
                                       Foreground="{DynamicResource FontBrush}"/>
                          </Button>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </StackPanel>

                  <!-- 内联操作按钮(hover 显示) -->
                  <StackPanel Grid.Column="3" Orientation="Horizontal" Classes="hoverActions"
                              VerticalAlignment="Center" Spacing="2">
                    <Button Classes="iconAction" ToolTip.Tip="Run"
                            Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).RunEditorCommand}"
                            CommandParameter="{Binding}">
                      <ic:SymbolIcon Symbol="Play" IconVariant="Filled" FontSize="16"
                                     Foreground="{DynamicResource SuccessBrush}"/>
                    </Button>
                    <Button Classes="iconAction" ToolTip.Tip="Show in File Manager"
                            Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ShowInFileManagerCommand}"
                            CommandParameter="{Binding}">
                      <ic:SymbolIcon Symbol="FolderOpen" IconVariant="Regular" FontSize="16"/>
                    </Button>
                    <Button Classes="iconAction" ToolTip.Tip="Remove"
                            Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ShowDeleteConfirmCommand}"
                            CommandParameter="{Binding}">
                      <ic:SymbolIcon Symbol="Dismiss" IconVariant="Regular" FontSize="16"/>
                    </Button>
                  </StackPanel>

                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>
    </DockPanel>

    <!-- ========== 右侧操作侧边栏 ========== -->
    <Border Grid.Column="1" Classes="sidebar" Width="180">
      <StackPanel Spacing="4">
        <TextBlock Text="Actions" FontSize="12" FontWeight="SemiBold"
                   Foreground="{DynamicResource FontDimBrush}" Margin="0,0,0,8"/>

        <StackPanel IsVisible="{Binding HasSelection}" Spacing="4">
          <Button Classes="action" HorizontalAlignment="Stretch"
                  Command="{Binding RunEditorCommand}" CommandParameter="{Binding SelectedEditor}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <ic:SymbolIcon Symbol="Play" IconVariant="Filled" FontSize="14"/>
              <TextBlock Text="Run" FontSize="13"/>
            </StackPanel>
          </Button>
          <Separator/>
          <Button Classes="action" HorizontalAlignment="Stretch"
                  Command="{Binding ShowRenameDialogCommand}" CommandParameter="{Binding SelectedEditor}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <ic:SymbolIcon Symbol="Rename" IconVariant="Regular" FontSize="14"/>
              <TextBlock Text="Rename" FontSize="13"/>
            </StackPanel>
          </Button>
          <Button Classes="action" HorizontalAlignment="Stretch"
                  Command="{Binding ShowTagDialogCommand}" CommandParameter="{Binding SelectedEditor}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <ic:SymbolIcon Symbol="Tag" IconVariant="Regular" FontSize="14"/>
              <TextBlock Text="Manage Tags" FontSize="13"/>
            </StackPanel>
          </Button>
          <Button Classes="action" HorizontalAlignment="Stretch"
                  Command="{Binding ShowExtraArgsDialogCommand}" CommandParameter="{Binding SelectedEditor}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <ic:SymbolIcon Symbol="Options" IconVariant="Regular" FontSize="14"/>
              <TextBlock Text="Extra Arguments" FontSize="13"/>
            </StackPanel>
          </Button>
          <Separator/>
          <Button Classes="action" HorizontalAlignment="Stretch"
                  Command="{Binding ShowReferencesCommand}" CommandParameter="{Binding SelectedEditor}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <ic:SymbolIcon Symbol="Link" IconVariant="Regular" FontSize="14"/>
              <TextBlock Text="View References" FontSize="13"/>
            </StackPanel>
          </Button>
          <Separator/>
          <Button Classes="action" HorizontalAlignment="Stretch"
                  Command="{Binding ShowInFileManagerCommand}" CommandParameter="{Binding SelectedEditor}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <ic:SymbolIcon Symbol="FolderOpen" IconVariant="Regular" FontSize="14"/>
              <TextBlock Text="Show in Files" FontSize="13"/>
            </StackPanel>
          </Button>
          <Button Classes="action" HorizontalAlignment="Stretch"
                  Command="{Binding CopyPathCommand}" CommandParameter="{Binding SelectedEditor}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <ic:SymbolIcon Symbol="ClipboardPaste" IconVariant="Regular" FontSize="14"/>
              <TextBlock Text="Copy Path" FontSize="13"/>
            </StackPanel>
          </Button>
          <Separator/>
          <Button Classes="action" HorizontalAlignment="Stretch"
                  Command="{Binding ShowDeleteConfirmCommand}" CommandParameter="{Binding SelectedEditor}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <ic:SymbolIcon Symbol="Delete" IconVariant="Regular" FontSize="14"/>
              <TextBlock Text="Remove" FontSize="13"/>
            </StackPanel>
          </Button>
        </StackPanel>

        <TextBlock IsVisible="{Binding !HasSelection}"
                   Text="Select an editor to see actions"
                   Foreground="{DynamicResource FontDimBrush}"
                   FontSize="12" TextWrapping="Wrap"
                   HorizontalAlignment="Center" Margin="0,20"/>
      </StackPanel>
    </Border>

    <!-- ========== 对话框覆盖层 ========== -->
    <Panel Grid.Column="0" Grid.ColumnSpan="2">

      <!-- 导入编辑器对话框 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsImportDialogVisible}"
              IsHitTestVisible="{Binding IsImportDialogVisible}">
        <Border Classes="dialogContent" MaxWidth="500" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="420">
            <TextBlock Text="Import Editor" Classes="title" Margin="0,0,0,8"/>
            <StackPanel Spacing="4">
              <TextBlock Text="Editor Name" FontSize="12"/>
              <TextBox Text="{Binding ImportEditorName, Mode=TwoWay}" Watermark="Godot v4.3 stable"/>
            </StackPanel>
            <StackPanel Spacing="4">
              <TextBlock Text="Executable Path" FontSize="12"/>
              <Grid ColumnDefinitions="*,Auto">
                <TextBox Grid.Column="0" Text="{Binding ImportEditorPath, Mode=TwoWay}" Watermark="/path/to/godot"/>
                <Button Grid.Column="1" Classes="action" Content="Browse" Margin="4,0,0,0"
                        Command="{Binding BrowseImportPathCommand}"/>
              </Grid>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
              <Button Content="Cancel" Classes="action" Command="{Binding CancelImportCommand}"/>
              <Button Content="Import" Classes="accent" Command="{Binding ConfirmImportCommand}"/>
            </StackPanel>
          </StackPanel>
        </Border>
      </Border>

      <!-- 重命名编辑器对话框 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsRenameDialogVisible}"
              IsHitTestVisible="{Binding IsRenameDialogVisible}">
        <Border Classes="dialogContent" MaxWidth="450" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="380">
            <TextBlock Text="Rename Editor" Classes="title" Margin="0,0,0,8"/>
            <StackPanel Spacing="4">
              <TextBlock Text="Name" FontSize="12"/>
              <TextBox Text="{Binding RenameEditorName, Mode=TwoWay}"/>
            </StackPanel>
            <StackPanel Spacing="4">
              <TextBlock Text="Version Hint" FontSize="12"/>
              <TextBox Text="{Binding RenameVersionHint, Mode=TwoWay}" Watermark="v4.3-stable"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
              <Button Content="Cancel" Classes="action" Command="{Binding CancelRenameCommand}"/>
              <Button Content="Rename" Classes="accent" Command="{Binding ConfirmRenameCommand}"/>
            </StackPanel>
          </StackPanel>
        </Border>
      </Border>

      <!-- 额外参数对话框 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsExtraArgsDialogVisible}"
              IsHitTestVisible="{Binding IsExtraArgsDialogVisible}">
        <Border Classes="dialogContent" MaxWidth="500" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="420">
            <TextBlock Text="Extra Arguments" Classes="title" Margin="0,0,0,8"/>
            <TextBlock Text="Additional command-line arguments to pass to the editor when launching."
                       FontSize="12" Foreground="{DynamicResource FontDimBrush}" TextWrapping="Wrap"/>
            <TextBox Text="{Binding ExtraArgsText, Mode=TwoWay}" Watermark="--verbose --headless"
                     AcceptsReturn="False"/>
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
              <Button Content="Cancel" Classes="action" Command="{Binding CancelExtraArgsCommand}"/>
              <Button Content="Save" Classes="accent" Command="{Binding ConfirmExtraArgsCommand}"/>
            </StackPanel>
          </StackPanel>
        </Border>
      </Border>

      <!-- 标签管理对话框 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsTagDialogVisible}"
              IsHitTestVisible="{Binding IsTagDialogVisible}">
        <Border Classes="dialogContent" MaxWidth="500" MaxHeight="450"
                HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="420">
            <TextBlock Text="Manage Tags" Classes="title" Margin="0,0,0,4"/>
            <StackPanel Spacing="4">
              <TextBlock Text="Assigned Tags" FontSize="12" Foreground="{DynamicResource FontDimBrush}"/>
              <ItemsControl ItemsSource="{Binding AssignedTags}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate><WrapPanel Orientation="Horizontal"/></ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Background="{DynamicResource AccentBrush}" CornerRadius="3"
                            Padding="6,2" Margin="0,2,4,2">
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="{Binding}" FontSize="11" Foreground="#1C2129"/>
                        <Button Padding="0" Background="Transparent" BorderThickness="0"
                                MinWidth="14" MinHeight="14" Cursor="Hand"
                                Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).RemoveTagCommand}"
                                CommandParameter="{Binding}">
                          <ic:SymbolIcon Symbol="Dismiss" FontSize="10" Foreground="#1C2129"/>
                        </Button>
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
            <Grid ColumnDefinitions="*,Auto" Margin="0,4,0,0">
              <TextBox Grid.Column="0" Text="{Binding NewTagText, Mode=TwoWay}"
                       Watermark="new_tag" Classes="searchBox"/>
              <Button Grid.Column="1" Classes="action" Content="Add" Margin="4,0,0,0"
                      Command="{Binding AddTagCommand}"/>
            </Grid>
            <StackPanel Spacing="4">
              <TextBlock Text="All Tags" FontSize="12" Foreground="{DynamicResource FontDimBrush}"/>
              <ItemsControl ItemsSource="{Binding AllKnownTags}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate><WrapPanel Orientation="Horizontal"/></ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Button Padding="6,2" Margin="0,2,4,2" CornerRadius="3" Cursor="Hand"
                            Background="{DynamicResource TagBrush}" BorderThickness="0"
                            Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).AssignKnownTagCommand}"
                            CommandParameter="{Binding}">
                      <TextBlock Text="{Binding}" FontSize="11" Foreground="{DynamicResource FontBrush}"/>
                    </Button>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
              <Button Content="Cancel" Classes="action" Command="{Binding CancelTagsCommand}"/>
              <Button Content="Save" Classes="accent" Command="{Binding ConfirmTagsCommand}"/>
            </StackPanel>
          </StackPanel>
        </Border>
      </Border>

      <!-- 删除确认对话框 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsDeleteConfirmVisible}"
              IsHitTestVisible="{Binding IsDeleteConfirmVisible}">
        <Border Classes="dialogContent" MaxWidth="420" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="360">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <ic:SymbolIcon Symbol="Warning" IconVariant="Filled" FontSize="20"
                             Foreground="{DynamicResource WarningBrush}"/>
              <TextBlock Text="Confirm Remove" Classes="title"/>
            </StackPanel>
            <TextBlock Text="{Binding DeleteConfirmMessage}" TextWrapping="Wrap" FontSize="13"/>
            <CheckBox Content="Also delete editor files from disk"
                      IsChecked="{Binding DeleteAlsoFromDisk}"/>
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
              <Button Content="Cancel" Classes="action" Command="{Binding CancelDeleteCommand}"/>
              <Button Content="Remove" Classes="accent" Command="{Binding ConfirmDeleteCommand}"
                      Background="{DynamicResource ErrorBrush}"/>
            </StackPanel>
          </StackPanel>
        </Border>
      </Border>

      <!-- 引用查看对话框 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsReferencesDialogVisible}"
              IsHitTestVisible="{Binding IsReferencesDialogVisible}">
        <Border Classes="dialogContent" MaxWidth="500" MaxHeight="400"
                HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="420">
            <TextBlock Text="Projects Using This Editor" Classes="title" Margin="0,0,0,4"/>
            <ScrollViewer MaxHeight="250" VerticalScrollBarVisibility="Auto">
              <ItemsControl ItemsSource="{Binding ReferencingProjects}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate DataType="models:GodotProject">
                    <Border Padding="6,4" Margin="0,1" CornerRadius="3"
                            Background="{DynamicResource DarkColor2}">
                      <StackPanel Spacing="2">
                        <TextBlock Text="{Binding Name}" FontSize="13" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding Path}" FontSize="11"
                                   Foreground="{DynamicResource FontDimBrush}"
                                   TextTrimming="CharacterEllipsis"/>
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
            <TextBlock Text="No projects reference this editor."
                       IsVisible="{Binding !ReferencingProjects.Count}"
                       Foreground="{DynamicResource FontDimBrush}" FontSize="12"
                       HorizontalAlignment="Center"/>
            <Button Content="Close" Classes="action" HorizontalAlignment="Right"
                    Command="{Binding CloseReferencesCommand}"/>
          </StackPanel>
        </Border>
      </Border>

    </Panel>
  </Grid>
</UserControl>
