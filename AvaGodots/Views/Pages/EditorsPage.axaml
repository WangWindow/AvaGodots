<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:AvaGodots.ViewModels.Pages"
             xmlns:models="using:AvaGodots.Models"
             mc:Ignorable="d"
             x:Class="AvaGodots.Views.Pages.EditorsPage"
             x:DataType="vm:EditorsPageViewModel">

  <DockPanel>

    <!-- ===== 顶部操作栏 ===== -->
    <Border DockPanel.Dock="Top" Padding="8,6">
      <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto">

        <!-- Local / Remote 切换 -->
        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="2" Margin="0,0,8,0">
          <ToggleButton Classes="titleTab" IsChecked="{Binding IsLocalView}"
                        Command="{Binding SwitchViewCommand}" CommandParameter="{x:True}">
            <TextBlock Text="{DynamicResource Editors.Local}" VerticalAlignment="Center" FontSize="13"/>
          </ToggleButton>
          <ToggleButton Classes="titleTab" IsChecked="{Binding !IsLocalView}"
                        Command="{Binding SwitchViewCommand}" CommandParameter="{x:False}">
            <TextBlock Text="{DynamicResource Editors.Remote}" VerticalAlignment="Center" FontSize="13"/>
          </ToggleButton>
        </StackPanel>

        <!-- 本地操作按钮 -->
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4"
                    IsVisible="{Binding IsLocalView}">
          <Button Classes="action" Command="{Binding ScanDirectoryCommand}">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <PathIcon Data="{StaticResource search_regular}" FontSize="14"/>
              <TextBlock Text="{DynamicResource Editors.Scan}" VerticalAlignment="Center" FontSize="13"/>
            </StackPanel>
          </Button>
          <Button Classes="action" Command="{Binding RemoveMissingEditorsCommand}">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <PathIcon Data="{StaticResource delete_regular}" FontSize="14"/>
              <TextBlock Text="{DynamicResource Editors.RemoveMissing}" VerticalAlignment="Center" FontSize="13"/>
            </StackPanel>
          </Button>
          <Button Classes="iconAction" Command="{Binding RefreshCommand}" ToolTip.Tip="{DynamicResource Common.Refresh}">
            <PathIcon Data="{StaticResource arrow_sync_regular}" FontSize="14"/>
          </Button>
        </StackPanel>

        <!-- 远程筛选条 -->
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6"
                    IsVisible="{Binding !IsLocalView}">
          <CheckBox Content="{DynamicResource Editors.Filter.Mono}" IsChecked="{Binding FilterMono}" FontSize="12"/>
          <CheckBox Content="{DynamicResource Editors.Filter.Unstable}" IsChecked="{Binding FilterUnstable}" FontSize="12"/>
          <CheckBox Content="{DynamicResource Editors.Filter.AnyPlatform}" IsChecked="{Binding FilterAnyPlatform}" FontSize="12"/>
          <CheckBox Content="{DynamicResource Editors.Filter.4x}" IsChecked="{Binding Filter4X}" FontSize="12"/>
          <CheckBox Content="{DynamicResource Editors.Filter.3x}" IsChecked="{Binding Filter3X}" FontSize="12"/>
          <CheckBox Content="{DynamicResource Editors.Filter.Other}" IsChecked="{Binding FilterOtherVersions}" FontSize="12"/>
          <Button Classes="iconAction" Command="{Binding LoadRemoteVersionsCommand}" ToolTip.Tip="{DynamicResource Editors.RefreshRemote}">
            <PathIcon Data="{StaticResource arrow_sync_regular}" FontSize="14"/>
          </Button>
        </StackPanel>

        <!-- 搜索 -->
        <TextBox Grid.Column="2" Classes="searchBox"
                 PlaceholderText="{DynamicResource Editors.FilterWatermark}"
                 Text="{Binding SearchText, Mode=TwoWay}"
                 Margin="8,0"
                 IsVisible="{Binding IsLocalView}"/>

        <!-- 排序 -->
        <ComboBox Grid.Column="4" Classes="sortCombo"
                  SelectedIndex="{Binding SortIndex}" MinWidth="120"
                  IsVisible="{Binding IsLocalView}">
          <ComboBoxItem Content="{DynamicResource Projects.Sort.Name}"/>
          <ComboBoxItem Content="{DynamicResource Projects.Sort.Path}"/>
          <ComboBoxItem Content="{DynamicResource Projects.Sort.Tags}"/>
        </ComboBox>
      </Grid>
    </Border>

    <!-- ===== 主内容区 ===== -->
    <Panel>

      <!-- ===== 本地编辑器视图 ===== -->
      <Panel IsVisible="{Binding IsLocalView}">

        <!-- 空状态 -->
        <StackPanel IsVisible="{Binding IsEmpty}"
                    HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8">
          <PathIcon Data="{StaticResource app_generic_regular}" FontSize="48"
                    Foreground="{DynamicResource FontDimBrush}" HorizontalAlignment="Center"/>
          <TextBlock Text="{DynamicResource Editors.Empty.Title}" FontSize="16" Foreground="{DynamicResource FontDimBrush}"
                     HorizontalAlignment="Center"/>
          <TextBlock Text="{DynamicResource Editors.Empty.Desc}"
                     FontSize="12" Foreground="{DynamicResource FontDimBrush}"
                     TextWrapping="Wrap" MaxWidth="400" HorizontalAlignment="Center" TextAlignment="Center"/>
        </StackPanel>

        <!-- 编辑器列表 -->
        <ListBox Classes="transparent" IsVisible="{Binding !IsEmpty}" ItemsSource="{Binding FilteredEditors}" Margin="8,0,8,8"
                 ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
          <ListBox.ItemTemplate>
            <DataTemplate DataType="models:GodotEditor">
              <Border Padding="8,6" CornerRadius="4" Margin="0,1"
                      Name="editorItem" Background="Transparent">
                <Border.Styles>
                  <Style Selector="Border#editorItem:pointerover">
                    <Setter Property="Background" Value="{DynamicResource HoverBrush}"/>
                  </Style>
                  <Style Selector="Border#editorItem StackPanel.hoverActions">
                    <Setter Property="Opacity" Value="0"/>
                    <Setter Property="IsHitTestVisible" Value="False"/>
                  </Style>
                  <Style Selector="Border#editorItem:pointerover StackPanel.hoverActions">
                    <Setter Property="Opacity" Value="1"/>
                    <Setter Property="IsHitTestVisible" Value="True"/>
                  </Style>
                </Border.Styles>

                <Border.ContextMenu>
                  <ContextMenu Opened="OnEditorContextMenuOpened">
                    <MenuItem Header="{DynamicResource Common.Run}" Tag="RunEditor">
                      <MenuItem.Icon><PathIcon Data="{StaticResource play_regular}" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="{DynamicResource Editors.Menu.Rename}" Tag="ShowRenameDialog">
                      <MenuItem.Icon><PathIcon Data="{StaticResource rename_regular}" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="{DynamicResource Editors.Menu.ExtraArgs}" Tag="ShowExtraArgsDialog">
                      <MenuItem.Icon><PathIcon Data="{StaticResource code_regular}" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="{DynamicResource Editors.Menu.ManageTags}" Tag="ShowTagDialog">
                      <MenuItem.Icon><PathIcon Data="{StaticResource tag_regular}" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="{DynamicResource Editors.Menu.ViewReferences}" Tag="ShowReferences">
                      <MenuItem.Icon><PathIcon Data="{StaticResource link_regular}" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="{DynamicResource Editors.Menu.ShowInFileManager}" Tag="ShowInFileManager">
                      <MenuItem.Icon><PathIcon Data="{StaticResource folder_open_regular}" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="{DynamicResource Editors.Menu.CopyPath}" Tag="CopyPath">
                      <MenuItem.Icon><PathIcon Data="{StaticResource clipboard_paste_regular}" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="{DynamicResource Common.Remove}" Tag="ShowDeleteConfirm">
                      <MenuItem.Icon><PathIcon Data="{StaticResource delete_regular}" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="{DynamicResource Editors.Menu.DownloadExportTemplate}" Tag="DownloadExportTemplate">
                      <MenuItem.Icon><PathIcon Data="{StaticResource download_regular}" FontSize="14"/></MenuItem.Icon>
                    </MenuItem>
                  </ContextMenu>
                </Border.ContextMenu>

                <Grid ColumnDefinitions="Auto,Auto,*,Auto" DoubleTapped="OnEditorDoubleTapped">
                  <!-- 收藏 -->
                  <ToggleButton Grid.Column="0" Classes="favorite" IsChecked="{Binding IsFavorite}"
                                VerticalAlignment="Center" Margin="0,0,6,0"
                                Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ToggleFavoriteCommand}"
                                CommandParameter="{Binding}">
                    <Panel>
                      <PathIcon Data="{StaticResource star_add_regular}" FontSize="16" IsVisible="{Binding !IsFavorite}"/>
                      <PathIcon Data="{StaticResource star_regular}" FontSize="16" IsVisible="{Binding IsFavorite}"
                                Foreground="{DynamicResource WarningBrush}"/>
                    </Panel>
                  </ToggleButton>

                  <!-- 图标 -->
                  <Border Grid.Column="1" Width="40" Height="40" Background="{DynamicResource DarkColor3}"
                          CornerRadius="4" Margin="0,0,10,0" VerticalAlignment="Center">
                    <PathIcon Data="{StaticResource app_generic_regular}" FontSize="20"
                              Foreground="{DynamicResource GodotBlueBrush}"
                              HorizontalAlignment="Center" VerticalAlignment="Center"/>
                  </Border>

                  <!-- 信息 -->
                  <StackPanel Grid.Column="2" VerticalAlignment="Center" Spacing="2">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                      <TextBlock Text="{Binding Name}" FontSize="14" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                      <Border Background="{DynamicResource TagBrush}" CornerRadius="3" Padding="6,1" VerticalAlignment="Center"
                              IsVisible="{Binding VersionHint, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Text="{Binding VersionHint}" FontSize="10" Foreground="{DynamicResource AccentBrush}"/>
                      </Border>
                    </StackPanel>
                    <TextBlock Text="{Binding Path}" Classes="path" MaxWidth="700"/>
                    <ItemsControl ItemsSource="{Binding Tags}" IsVisible="{Binding Tags.Count}">
                      <ItemsControl.ItemsPanel><ItemsPanelTemplate><WrapPanel Orientation="Horizontal"/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate><DataTemplate>
                        <Button Classes="tagButton" Margin="0,2,4,0" Padding="6,2" Background="{DynamicResource TagBrush}" CornerRadius="3" BorderThickness="0" Cursor="Hand"
                                Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).FilterByTagCommand}" CommandParameter="{Binding}">
                          <TextBlock Text="{Binding}" FontSize="11" Foreground="{DynamicResource FontBrush}"/>
                        </Button>
                      </DataTemplate></ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </StackPanel>

                  <!-- hover 操作 -->
                  <StackPanel Grid.Column="3" Orientation="Horizontal" Classes="hoverActions" VerticalAlignment="Center" Spacing="2">
                    <Button Classes="iconAction" ToolTip.Tip="{DynamicResource Common.Run}" Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).RunEditorCommand}" CommandParameter="{Binding}">
                      <PathIcon Data="{StaticResource play_regular}" FontSize="16" Foreground="{DynamicResource SuccessBrush}"/>
                    </Button>
                    <Button Classes="iconAction" ToolTip.Tip="{DynamicResource Editors.Menu.ShowInFileManager}" Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ShowInFileManagerCommand}" CommandParameter="{Binding}">
                      <PathIcon Data="{StaticResource folder_open_regular}" FontSize="16"/>
                    </Button>
                    <Button Classes="iconAction" ToolTip.Tip="{DynamicResource Common.Remove}" Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).ShowDeleteConfirmCommand}" CommandParameter="{Binding}">
                      <PathIcon Data="{StaticResource dismiss_regular}" FontSize="16"/>
                    </Button>
                  </StackPanel>
                </Grid>
              </Border>
            </DataTemplate>
          </ListBox.ItemTemplate>
        </ListBox>
      </Panel>

      <!-- ===== 远程编辑器视图 ===== -->
      <Panel IsVisible="{Binding !IsLocalView}">

        <!-- 加载中 -->
        <StackPanel IsVisible="{Binding IsRemoteLoading}"
                    HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8">
          <ProgressBar IsIndeterminate="True" Width="200"/>
          <TextBlock Text="{DynamicResource Editors.Remote.Loading}" FontSize="13"
                     Foreground="{DynamicResource FontDimBrush}" HorizontalAlignment="Center"/>
        </StackPanel>

        <!-- 空 -->
        <StackPanel IsVisible="{Binding IsRemoteEmpty}"
                    HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8">
          <PathIcon Data="{StaticResource cloud_regular}" FontSize="48"
                    Foreground="{DynamicResource FontDimBrush}" HorizontalAlignment="Center"/>
          <TextBlock Text="{DynamicResource Editors.Remote.Empty.Title}" FontSize="16"
                     Foreground="{DynamicResource FontDimBrush}" HorizontalAlignment="Center"/>
          <TextBlock Text="{DynamicResource Editors.Remote.Empty.Desc}"
                     FontSize="12" Foreground="{DynamicResource FontDimBrush}"
                     TextWrapping="Wrap" MaxWidth="400" HorizontalAlignment="Center" TextAlignment="Center"/>
        </StackPanel>

        <!-- 远程版本树 -->
        <TreeView IsVisible="{Binding !IsRemoteEmpty}"
                  ItemsSource="{Binding RemoteVersions}"
                  Margin="8">
          <TreeView.Styles>
            <Style Selector="TreeViewItem" x:DataType="models:RemoteVersionNode">
              <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
            </Style>
          </TreeView.Styles>
          <TreeView.ItemTemplate>
            <TreeDataTemplate ItemsSource="{Binding Children}" DataType="models:RemoteVersionNode">
              <Border Padding="4,3" CornerRadius="4" Name="remoteRow" Background="Transparent">
                <Border.Styles>
                  <Style Selector="Border#remoteRow:pointerover">
                    <Setter Property="Background" Value="{DynamicResource HoverBrush}"/>
                  </Style>
                </Border.Styles>
                <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                  <!-- 文件夹 / 文件图标 -->
                  <Panel Grid.Column="0" Margin="0,0,6,0" VerticalAlignment="Center">
                    <PathIcon Data="{StaticResource folder_regular}" FontSize="16" IsVisible="{Binding IsFolder}"/>
                    <PathIcon Data="{StaticResource document_regular}" FontSize="16" IsVisible="{Binding !IsFolder}"/>
                  </Panel>
                  <!-- 名称 -->
                  <TextBlock Grid.Column="1" Text="{Binding Name}" FontSize="13" VerticalAlignment="Center"
                             TextTrimming="CharacterEllipsis"/>
                  <!-- 加载指示 -->
                  <ProgressBar Grid.Column="2" IsIndeterminate="True" Width="60" Height="4"
                               Margin="8,0" IsVisible="{Binding IsLoading}" VerticalAlignment="Center"/>
                  <!-- 文件大小 + 下载按钮 -->
                  <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center"
                              IsVisible="{Binding !IsFolder}">
                    <TextBlock Text="{Binding FileSize}" FontSize="11"
                               Foreground="{DynamicResource FontDimBrush}" VerticalAlignment="Center"/>
                    <Button Classes="iconAction" Padding="4" CornerRadius="3"
                            ToolTip.Tip="{DynamicResource Common.Download}"
                            Command="{Binding $parent[TreeView].((vm:EditorsPageViewModel)DataContext).DownloadRemoteEditorCommand}"
                            CommandParameter="{Binding}">
                      <PathIcon Data="{StaticResource arrow_download_regular}" FontSize="14"
                                Foreground="{DynamicResource AccentBrush}"/>
                    </Button>
                  </StackPanel>
                </Grid>
              </Border>
            </TreeDataTemplate>
          </TreeView.ItemTemplate>
        </TreeView>
      </Panel>

      <!-- ===== 对话框 ===== -->

      <!-- 重命名 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsRenameDialogVisible}" IsHitTestVisible="{Binding IsRenameDialogVisible}">
        <Border Classes="dialogContent" MaxWidth="450" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="380">
            <TextBlock Text="{DynamicResource Editors.Dialog.RenameTitle}" Classes="title" Margin="0,0,0,8"/>
            <StackPanel Spacing="4">
              <TextBlock Text="{DynamicResource Editors.Dialog.Name}" FontSize="12"/>
              <TextBox Text="{Binding RenameEditorName, Mode=TwoWay}"/>
            </StackPanel>
            <StackPanel Spacing="4"><TextBlock Text="{DynamicResource Editors.Dialog.VersionHint}" FontSize="12"/>
              <TextBox Text="{Binding RenameVersionHint, Mode=TwoWay}" PlaceholderText="e.g. 4.3-stable"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
              <Button Content="{DynamicResource Common.Cancel}" Classes="action" Command="{Binding CancelRenameCommand}"/>
              <Button Content="{DynamicResource Common.Rename}" Classes="accent" Command="{Binding ConfirmRenameCommand}"/>
            </StackPanel>
          </StackPanel>
        </Border>
      </Border>

      <!-- 额外参数 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsExtraArgsDialogVisible}" IsHitTestVisible="{Binding IsExtraArgsDialogVisible}">
        <Border Classes="dialogContent" MaxWidth="500" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="420">
            <TextBlock Text="{DynamicResource Editors.Dialog.ExtraArgsTitle}" Classes="title" Margin="0,0,0,8"/>
            <TextBlock Text="{DynamicResource Editors.Dialog.ExtraArgsDesc}"
                       FontSize="12" Foreground="{DynamicResource FontDimBrush}" TextWrapping="Wrap"/>
            <TextBox Text="{Binding ExtraArgsText, Mode=TwoWay}" PlaceholderText="--verbose --headless"/>
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
              <Button Content="{DynamicResource Common.Cancel}" Classes="action" Command="{Binding CancelExtraArgsCommand}"/>
              <Button Content="{DynamicResource Common.Save}" Classes="accent" Command="{Binding ConfirmExtraArgsCommand}"/>
            </StackPanel>
          </StackPanel>
        </Border>
      </Border>

      <!-- 标签管理 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsTagDialogVisible}" IsHitTestVisible="{Binding IsTagDialogVisible}">
        <Border Classes="dialogContent" MaxWidth="500" MaxHeight="450" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="420">
            <TextBlock Text="{DynamicResource Editors.Dialog.ManageTags}" Classes="title" Margin="0,0,0,4"/>
            <StackPanel Spacing="4"><TextBlock Text="{DynamicResource Projects.Dialog.AssignedTags}" FontSize="12" Foreground="{DynamicResource FontDimBrush}"/>
              <ItemsControl ItemsSource="{Binding AssignedTags}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel Orientation="Horizontal"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate><DataTemplate><Border Background="{DynamicResource AccentBrush}" CornerRadius="3" Padding="6,2" Margin="0,2,4,2">
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock Text="{Binding}" FontSize="11" Foreground="#1C2129"/>
                    <Button Padding="0" Background="Transparent" BorderThickness="0" MinWidth="14" MinHeight="14" Cursor="Hand"
                            Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).RemoveTagCommand}" CommandParameter="{Binding}">
                      <PathIcon Data="{StaticResource dismiss_regular}" FontSize="10" Foreground="#1C2129"/>
                    </Button>
                  </StackPanel>
                </Border>
                </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
            <Grid ColumnDefinitions="*,Auto" Margin="0,4,0,0">
              <TextBox Grid.Column="0" Text="{Binding NewTagText, Mode=TwoWay}" PlaceholderText="new_tag" Classes="searchBox"/>
              <Button Grid.Column="1" Classes="action" Content="{DynamicResource Common.Add}" Margin="4,0,0,0" Command="{Binding AddTagCommand}"/>
            </Grid>
            <StackPanel Spacing="4"><TextBlock Text="{DynamicResource Projects.Dialog.AllTags}" FontSize="12" Foreground="{DynamicResource FontDimBrush}"/>
              <ItemsControl ItemsSource="{Binding AllKnownTags}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel Orientation="Horizontal"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Button Padding="6,2" Margin="0,2,4,2" CornerRadius="3" Cursor="Hand" Background="{DynamicResource TagBrush}" BorderThickness="0"
                            Command="{Binding $parent[ItemsControl].((vm:EditorsPageViewModel)DataContext).AssignKnownTagCommand}" CommandParameter="{Binding}">
                      <TextBlock Text="{Binding}" FontSize="11" Foreground="{DynamicResource FontBrush}"/>
                    </Button>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
              <Button Content="{DynamicResource Common.Cancel}" Classes="action" Command="{Binding CancelTagsCommand}"/>
              <Button Content="{DynamicResource Common.Save}" Classes="accent" Command="{Binding ConfirmTagsCommand}"/>
            </StackPanel>
          </StackPanel>
        </Border>
      </Border>

      <!-- 删除确认 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsDeleteConfirmVisible}" IsHitTestVisible="{Binding IsDeleteConfirmVisible}">
        <Border Classes="dialogContent" MaxWidth="400" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="340">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <PathIcon Data="{StaticResource warning_regular}" FontSize="20" Foreground="{DynamicResource WarningBrush}"/>
              <TextBlock Text="{DynamicResource Editors.Dialog.ConfirmRemove}" Classes="title"/>
            </StackPanel>
            <TextBlock Text="{Binding DeleteConfirmMessage}" TextWrapping="Wrap" FontSize="13"/>
            <CheckBox Content="{DynamicResource Editors.Dialog.AlsoDeleteFiles}" IsChecked="{Binding DeleteAlsoFromDisk}"/>
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
              <Button Content="{DynamicResource Common.Cancel}" Classes="action" Command="{Binding CancelDeleteCommand}"/>
              <Button Content="{DynamicResource Common.Remove}" Classes="accent" Command="{Binding ConfirmDeleteCommand}" Background="{DynamicResource ErrorBrush}"/>
            </StackPanel>
          </StackPanel>
        </Border>
      </Border>

      <!-- 引用查看 -->
      <Border Classes="dialogOverlay" IsVisible="{Binding IsReferencesDialogVisible}" IsHitTestVisible="{Binding IsReferencesDialogVisible}">
        <Border Classes="dialogContent" MaxWidth="500" MaxHeight="400" HorizontalAlignment="Center" VerticalAlignment="Center">
          <StackPanel Spacing="12" Width="420">
            <TextBlock Text="{DynamicResource Editors.Dialog.ReferencesTitle}" Classes="title" Margin="0,0,0,8"/>
            <ScrollViewer MaxHeight="260" VerticalScrollBarVisibility="Auto">
              <ItemsControl ItemsSource="{Binding ReferencingProjects}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate DataType="models:GodotProject">
                    <Border Padding="6,3" Background="{DynamicResource DarkColor3}" CornerRadius="3" Margin="0,2">
                      <StackPanel Spacing="2">
                        <TextBlock Text="{Binding Name}" FontSize="13" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding Path}" Classes="path"/>
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
            <TextBlock Text="{DynamicResource Editors.Dialog.NoReferences}" FontSize="12"
                       Foreground="{DynamicResource FontDimBrush}"
                       IsVisible="{Binding !ReferencingProjects.Count}"/>
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
              <Button Content="{DynamicResource Common.Close}" Classes="accent" Command="{Binding CloseReferencesCommand}"/>
            </StackPanel>
          </StackPanel>
        </Border>
      </Border>
    </Panel>
  </DockPanel>
</UserControl>
